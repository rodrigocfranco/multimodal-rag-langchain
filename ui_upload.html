<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Upload PDF - Knowledge Base</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 0 20px;
      color: #333;
      line-height: 1.6;
    }
    h2 { margin-bottom: 20px; color: #1a1a1a; }
    .card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 24px;
      background: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .form-group { margin-bottom: 16px; }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #555;
    }
    input[type="file"],
    input[type="password"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .button-group {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 20px;
    }
    button {
      padding: 12px 20px;
      border: none;
      border-radius: 6px;
      background: #0066cc;
      color: white;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover:not(:disabled) { background: #0052a3; }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    #output {
      margin-top: 20px;
      padding: 12px;
      border-radius: 4px;
      display: none;
    }
    #output.show { display: block; }
    #output.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    #output.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    #output.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    .progress {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 12px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .help-text {
      margin-top: 20px;
      padding: 12px;
      background: #f8f9fa;
      border-left: 3px solid #0066cc;
      font-size: 14px;
      color: #666;
    }
  </style>
</head>
<body>
  <h2>Upload PDF para Knowledge Base</h2>

  <div class="card">
    <form id="uploadForm">
      <div class="form-group">
        <label for="pdfFile">Selecione um arquivo PDF:</label>
        <input type="file" id="pdfFile" name="file" accept="application/pdf" required>
      </div>

      <div class="form-group">
        <label for="apiKey">API Key (opcional):</label>
        <input type="password" id="apiKey" name="api_key" placeholder="Deixe em branco se não configurada">
      </div>

      <div class="button-group">
        <button type="button" id="uploadBtn">Enviar e Processar</button>
        <button type="button" id="streamBtn">Enviar com Progresso (Tempo Real)</button>
      </div>
    </form>

    <div id="output"></div>
  </div>

  <div class="help-text">
    <strong>Como funciona:</strong><br>
    1. Selecione um arquivo PDF<br>
    2. Clique em um dos botões acima<br>
    3. Aguarde o processamento (5-10 minutos)<br>
    4. Após concluído, faça perguntas em <code>/chat</code>
  </div>

  <script>
    const form = document.getElementById('uploadForm');
    const fileInput = document.getElementById('pdfFile');
    const apiKeyInput = document.getElementById('apiKey');
    const uploadBtn = document.getElementById('uploadBtn');
    const streamBtn = document.getElementById('streamBtn');
    const output = document.getElementById('output');

    function showMessage(message, type = 'info') {
      output.className = 'show ' + type;
      output.innerHTML = message;
    }

    function hideMessage() {
      output.className = '';
      output.innerHTML = '';
    }

    function setLoading(isLoading) {
      uploadBtn.disabled = isLoading;
      streamBtn.disabled = isLoading;

      if (isLoading) {
        uploadBtn.textContent = 'Processando...';
        streamBtn.textContent = 'Processando...';
      } else {
        uploadBtn.textContent = 'Enviar e Processar';
        streamBtn.textContent = 'Enviar com Progresso (Tempo Real)';
      }
    }

    async function uploadPDF(endpoint, useStreaming = false) {
      const file = fileInput.files[0];
      if (!file) {
        showMessage('Por favor, selecione um arquivo PDF primeiro.', 'error');
        return;
      }

      const formData = new FormData();
      formData.append('file', file);
      if (apiKeyInput.value) {
        formData.append('api_key', apiKeyInput.value);
      }

      setLoading(true);
      hideMessage();

      try {
        if (useStreaming) {
          await handleStreamingUpload(endpoint, formData);
        } else {
          await handleNormalUpload(endpoint, formData);
        }
      } catch (error) {
        console.error('Upload error:', error);

        // Se já houver log visível (streaming), adicionar erro ao final
        const existingLog = document.getElementById('progressLog');
        if (existingLog) {
          existingLog.textContent += '\n\n❌ ERRO DE CONEXÃO:\n' + error.message + '\n';
          existingLog.textContent += '\nO processamento pode ter continuado no servidor. Verifique em /manage.\n';
          existingLog.scrollTop = existingLog.scrollHeight;
        } else {
          // Mostrar erro simples se não houver log
          showMessage('❌ ERRO: ' + error.message + '\n\nO processamento pode ter continuado no servidor. Verifique em /manage.', 'error');
        }
      } finally {
        setLoading(false);
      }
    }

    async function handleNormalUpload(endpoint, formData) {
      showMessage('Enviando arquivo... Isso pode levar alguns minutos.', 'info');

      const response = await fetch(endpoint, {
        method: 'POST',
        body: formData
      });

      const result = await response.json();

      if (response.ok) {
        // Mostrar mensagem de sucesso + detalhes se disponíveis
        let message = '✅ SUCESSO!\n\n' + (result.message || 'PDF processado e adicionado ao knowledge base.');
        if (result.details) {
          message += '\n\nDetalhes:\n' + JSON.stringify(result.details, null, 2);
        }
        output.className = 'show success';
        output.innerHTML = '<div class="progress">' + message + '</div>';
        form.reset();
      } else {
        // Mostrar erro detalhado + traceback se disponível
        let errorMsg = '❌ ERRO DURANTE O PROCESSAMENTO\n\n';
        errorMsg += 'Mensagem: ' + (result.error || 'Falha ao processar o arquivo.') + '\n';

        if (result.details) {
          errorMsg += '\nDetalhes:\n' + result.details;
        }
        if (result.traceback) {
          errorMsg += '\n\n--- TRACEBACK COMPLETO ---\n' + result.traceback;
        }

        output.className = 'show error';
        output.innerHTML = '<div class="progress">' + errorMsg + '</div>';
      }
    }

    async function handleStreamingUpload(endpoint, formData) {
      // Criar AbortController para timeout manual (15 minutos)
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 15 * 60 * 1000);

      let response;
      try {
        response = await fetch(endpoint, {
          method: 'POST',
          body: formData,
          signal: controller.signal,
          // Importante: keepalive para conexões longas
          keepalive: true
        });
      } catch (fetchError) {
        clearTimeout(timeoutId);
        if (fetchError.name === 'AbortError') {
          throw new Error('Timeout: Processamento levou mais de 15 minutos. Verifique os logs do servidor.');
        }
        throw new Error(`Erro de rede: ${fetchError.message}. O servidor pode estar processando em background.`);
      }

      clearTimeout(timeoutId);

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      const reader = response.body.getReader();
      const decoder = new TextDecoder();

      output.className = 'show info';
      output.innerHTML = '<div class="progress" id="progressLog">Iniciando processamento...\n</div>';

      const progressLog = document.getElementById('progressLog');
      let buffer = '';
      let lastActivity = Date.now();

      // Monitorar atividade da stream
      const activityChecker = setInterval(() => {
        const inactiveSeconds = Math.floor((Date.now() - lastActivity) / 1000);
        if (inactiveSeconds > 120) {
          progressLog.textContent += `\n⚠️ Sem atividade por ${inactiveSeconds}s - processamento pode ter parado...\n`;
          progressLog.scrollTop = progressLog.scrollHeight;
        }
      }, 10000);

      try {
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          lastActivity = Date.now();
          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop();

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              const data = line.substring(6);
              progressLog.textContent += data + '\n';
              progressLog.scrollTop = progressLog.scrollHeight;
            }
          }
        }
      } finally {
        clearInterval(activityChecker);
      }

      // MANTER O LOG COMPLETO VISÍVEL + adicionar mensagem de status no final
      const finalText = progressLog.textContent;
      const statusDiv = document.createElement('div');
      statusDiv.style.marginTop = '16px';
      statusDiv.style.padding = '12px';
      statusDiv.style.borderRadius = '4px';
      statusDiv.style.fontWeight = 'bold';

      if (finalText.includes('PDF processado com sucesso')) {
        statusDiv.style.background = '#d4edda';
        statusDiv.style.color = '#155724';
        statusDiv.style.border = '2px solid #28a745';
        statusDiv.textContent = '✅ PDF PROCESSADO COM SUCESSO!';
        output.className = 'show success';
        form.reset();
      } else if (finalText.includes('Erro')) {
        statusDiv.style.background = '#f8d7da';
        statusDiv.style.color = '#721c24';
        statusDiv.style.border = '2px solid #dc3545';
        statusDiv.textContent = '❌ ERRO DURANTE O PROCESSAMENTO - Veja detalhes no log acima';
        output.className = 'show error';
      } else {
        statusDiv.style.background = '#d1ecf1';
        statusDiv.style.color = '#0c5460';
        statusDiv.style.border = '2px solid #17a2b8';
        statusDiv.textContent = 'ℹ️ PROCESSAMENTO CONCLUÍDO';
        output.className = 'show info';
      }

      // Adicionar status ao final do log (sem apagar o log)
      output.appendChild(statusDiv);
    }

    uploadBtn.addEventListener('click', () => uploadPDF('/upload', false));
    streamBtn.addEventListener('click', () => uploadPDF('/upload-stream', true));
  </script>
</body>
</html>
