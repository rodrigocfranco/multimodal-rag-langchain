<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Debug Retrieval</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;max-width:1200px;margin:40px auto;padding:0 16px;color:#222}
    .card{border:1px solid #ddd;border-radius:10px;padding:24px;margin-bottom:20px}
    .row{margin:12px 0}
    input,button,textarea{padding:10px;border-radius:8px;border:1px solid #ccc;width:100%}
    button{background:#1f6feb;color:#fff;border:none;cursor:pointer;width:auto}
    pre{background:#f6f8fa;padding:12px;border-radius:6px;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word;max-height:600px;overflow-y:auto}
    .muted{color:#666;font-size:14px}
    .doc{background:#fff;border:1px solid #e1e4e8;padding:12px;margin:8px 0;border-radius:6px}
    .doc-header{font-weight:bold;margin-bottom:8px;color:#0969da}
  </style>
</head>
<body>
  <h2>üîç Debug Retrieval</h2>

  <div class="card">
    <h3>Query</h3>
    <div class="row">
      <textarea id="question" rows="3" placeholder="Digite sua pergunta...">Quais s√£o todos os crit√©rios de muito alto risco cardiovascular segundo a diretriz brasileira de diabetes?</textarea>
    </div>
    <div class="row">
      <button id="testBtn">Testar Retrieval</button>
    </div>
  </div>

  <div id="results"></div>

  <script>
    const question = document.getElementById('question');
    const testBtn = document.getElementById('testBtn');
    const results = document.getElementById('results');

    testBtn.addEventListener('click', async () => {
      const q = question.value.trim();
      if (!q) return;

      results.innerHTML = '<div class="card"><p class="muted">Buscando...</p></div>';

      try {
        const res = await fetch('/debug-retrieval', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({question: q})
        });

        const data = await res.json();

        if (!res.ok) {
          results.innerHTML = `<div class="card"><h3>Erro</h3><pre>${JSON.stringify(data, null, 2)}</pre></div>`;
          return;
        }

        // Mostrar resultados
        let html = '';

        // Raw retrieval - Buscar keywords nos 30 docs
        const rawAllContent = data.raw_retrieval.docs_full.map(d => d.content.toLowerCase()).join(' ');
        const rawKeywords = {
          '3 ou mais fatores': rawAllContent.includes('3 ou mais fatores') || rawAllContent.includes('tr√™s ou mais fatores'),
          'hipercolesterolemia familiar': rawAllContent.includes('hipercolesterolemia familiar'),
          'albumin√∫ria >300': rawAllContent.includes('albumin√∫ria >300') || rawAllContent.includes('albumin'),
          'tfg <30': rawAllContent.includes('tfg <30') || rawAllContent.includes('tfg<30'),
          'retinopatia proliferativa': rawAllContent.includes('retinopatia proliferativa'),
          's√≠ndrome coronariana': rawAllContent.includes('s√≠ndrome coronariana') || rawAllContent.includes('sindrome coronariana')
        };

        html += `
          <div class="card">
            <h3>1Ô∏è‚É£ Raw Retrieval (MultiVectorRetriever)</h3>
            <p><strong>Count:</strong> ${data.raw_retrieval.count} documentos</p>
            <h4>Keywords nos 30 docs:</h4>
            <pre>${JSON.stringify(rawKeywords, null, 2)}</pre>
          </div>
        `;

        // Reranked
        html += `
          <div class="card">
            <h3>2Ô∏è‚É£ Reranked (Cohere)</h3>
            <p><strong>Count:</strong> ${data.reranked.count} documentos (top ${data.reranked.count} ap√≥s rerank)</p>
          </div>
        `;

        // Documentos completos
        html += `
          <div class="card">
            <h3>3Ô∏è‚É£ Documentos Rerankeados (Conte√∫do Completo)</h3>
            <p class="muted">Verifique se "3 ou mais fatores de risco" e "Hipercolesterolemia Familiar" aparecem em algum doc:</p>
        `;

        data.reranked.docs_full.forEach(doc => {
          html += `
            <div class="doc">
              <div class="doc-header">Doc ${doc.index + 1} (${doc.type}) - ${doc.full_length} chars</div>
              <pre>${doc.content}</pre>
              ${doc.metadata ? `<p class="muted">Metadata: ${JSON.stringify(doc.metadata, null, 2)}</p>` : ''}
            </div>
          `;
        });

        html += `</div>`;

        // Buscar keywords nos docs
        const allContent = data.reranked.docs_full.map(d => d.content.toLowerCase()).join(' ');
        const keywords = {
          '3 ou mais fatores': allContent.includes('3 ou mais fatores') || allContent.includes('tr√™s ou mais fatores'),
          'hipercolesterolemia familiar': allContent.includes('hipercolesterolemia familiar'),
          'albumin√∫ria >300': allContent.includes('albumin√∫ria >300') || allContent.includes('albumin'),
          'tfg <30': allContent.includes('tfg <30') || allContent.includes('tfg<30'),
          'retinopatia proliferativa': allContent.includes('retinopatia proliferativa'),
          's√≠ndrome coronariana': allContent.includes('s√≠ndrome coronariana') || allContent.includes('sindrome coronariana')
        };

        html += `
          <div class="card">
            <h3>4Ô∏è‚É£ Keywords Encontradas</h3>
            <pre>${JSON.stringify(keywords, null, 2)}</pre>
          </div>
        `;

        results.innerHTML = html;

      } catch (err) {
        results.innerHTML = `<div class="card"><h3>Erro</h3><pre>${err.message}</pre></div>`;
      }
    });
  </script>
</body>
</html>
